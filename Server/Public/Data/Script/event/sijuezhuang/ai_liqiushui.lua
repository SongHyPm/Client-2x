--Æ®Ãì·å ÀîÇïË®AI

--A ¡¾Ğ¡ÎŞÏà¹¦¡¿¸ø×Ô¼ºÓÃ¸ö¿Õ¼¼ÄÜ....ÔÙ¸øËæ»ú¸øÒ»¸öÍæ¼ÒÊ§Ã÷....
--B ¡¾½£Îè¡¿¸ø×Ô¼ºÓÃÒ»¸ö¿Õ¼¼ÄÜ....½ÓÏÂÀ´15sÄÚÒÀ´Î¸øÈ«¸±±¾Íæ¼Ò¼ÓÉËº¦ÖµÖğ½¥¼Ó´óµÄÉËº¦buff....
--C ¡¾È÷ÍÑ¡¿¸ø×Ô¼ºÓÃÒ»¸öÇåbuffµÄ¼¼ÄÜ....
--D ¡¾±ù±¬¡¿¸ø×Ô¼ºÓÃ¸ö¿Õ¼¼ÄÜ....ÔÙ¸øËæ»ú¸øÍæ¼Ò½ÅÏÂ·Å¸öÏİÚå....
--E ¡¾¿ñ±©¡¿¸ø×Ô¼º¼Ó·è¿ñµÄbuff....²»ÔÙÊ¹ÓÃÆäËû¼¼ÄÜ....

--È«³Ì¶¼´øÓĞÃâÒßÖÆ¶¨¼¼ÄÜµÄbuff....
--Õ½¶·¿ªÊ¼Í¬Ê±Ã¿¸ô10ÃëÓÃA¼¼ÄÜ....
--µ±HP½µÎª66%ºÍ33%Ê±·Ö±ğÊ¹ÓÃB¼¼ÄÜ....B¼¼ÄÜµÄ³ÖĞøÊ±¼äÄÚ....ÆäËü¼¼ÄÜCDµ½ÁË²»Ê¹ÓÃ....
--Ã¿¸ô20ÃëÓÃC¼¼ÄÜ....
--Ã¿¸ô20ÃëÓÃD¼¼ÄÜ....


--½Å±¾ºÅ
x893069_g_ScriptId	= 893069

--¸±±¾Âß¼­½Å±¾ºÅ....
x893069_g_FuBenScriptId = 893063


--ÃâÒßÌØ¶¨¼¼ÄÜbuff....
x893069_Buff_MianYi1	= 10472	--ÃâÒßÒ»Ğ©¸ºÃæĞ§¹û....
x893069_Buff_MianYi2	= 10471	--ÃâÒßÆÕÍ¨ÒşÉí....

--AĞ¡ÎŞÏà¹¦....
x893069_SkillA_ID			= 1640
x893069_SkillA_BID			= 1638
x893069_SkillA_Buff		=	22440
x893069_SkillA_CD			= 60000

--B½£Îè....
x893069_SkillB_SkillIDTbl = { 1043, 1044, 1045, 1046, 1047 }
x893069_SkillB_WeatherTbl = { 11, 12, 13, 14, 15 }
x893069_SkillB_LongZhuTbl = { "Mu_Boss", "Tu_Boss", "Huo_Boss", "Jin_Boss", "Shui_Boss" }
x893069_SkillB_TalkTbl =
{
	"Các ngß½i c¦n th§n, ta ğã tri®u h°i Long Trø!",
	"Các ngß½i c¦n th§n, ta ğã tri®u h°i Long Trø!",
	"Các ngß½i c¦n th§n, ta ğã tri®u h°i Long Trø!",
	"Các ngß½i c¦n th§n, ta ğã tri®u h°i Long Trø!",
	"Các ngß½i c¦n th§n, ta ğã tri®u h°i Long Trø!"
}

x893069_SkillB_Text =
{
	"Phan Tinh Tinh: Chú ı, #GBàng Xí#W ğã tri®u t§p #GLong Trø: Mµc#W, mau mau kh¡c chª #GLong Trø: Mµc#W b¢ng #GLong Trø: Kim#W bên cÕnh ği, nªu không e r¢ng không ai có th¬ toàn mÕng cä!",
	"Phan Tinh Tinh: Chú ı, #GBàng Xí#W ğã tri®u t§p #GLong Trø: Th±#W, mau mau kh¡c chª #GLong Trø: Th±#W b¢ng #GLong Trø: Mµc#W bên cÕnh ği, nªu không e r¢ng không ai có th¬ toàn mÕng cä!",
	"Phan Tinh Tinh: Chú ı, #GBàng Xí#W ğã tri®u t§p #GLong Trø: Höa#W, mau mau kh¡c chª #GLong Trø: Höa#W b¢ng #GLong Trø: Thüy#W bên cÕnh ği, nªu không e r¢ng không ai có th¬ toàn mÕng cä!",
	"Phan Tinh Tinh: Chú ı, #GBàng Xí#W ğã tri®u t§p #GLong Trø: Kim#W, mau mau kh¡c chª #GLong Trø: Kim#W b¢ng #GLong Trø: Höa#W bên cÕnh ği, nªu không e r¢ng không ai có th¬ toàn mÕng cä!",
	"Phan Tinh Tinh: Chú ı, #GBàng Xí#W ğã tri®u t§p #GLong Trø: Thüy#W, mau mau kh¡c chª #GLong Trø: Thüy#W b¢ng #GLong Trø: Th±#W bên cÕnh ği, nªu không e r¢ng không ai có th¬ toàn mÕng cä!"
}

x893069_SkillB_BuffIDTbl =
{
	[1] = {22446,22446},
	[2] = {22447,22447},
	[3] = {22448,22448},
	[4] = {22449,22449},
	[5] = {22450,22450}
}

--CÈ÷ÍÑ....
x893069_SkillC_ID		= 1639
x893069_SkillC_CD		= 5000

--D±ù±¬....
x893069_SkillD_ID		= 1639
x893069_SkillD_CD		= 20000
x893069_SkillD_SpecObj = 59

--E¿ñ±©....
x893069_SkillE_Buff1	= 10234
x893069_SkillE_Buff2	= 10235
--¿ªÊ¼½øÈë¿ñ±©×´Ì¬µÄÊ±¼ä....
x893069_EnterKuangBaoTime	= 10*60*1000

--FÊ®²½Ò»É±....
x893069_SkillF_ID		= 1643
x893069_SkillF_SpecObjTbl = { 162, 163, 164, 165, 166, 167 }

--GÆúÜ‡±£Ë§....
x893069_SkillG_ID		= 1642

--Ğ¡¹ÖÅÜ
x893069_g_DogfacePos = {
	{ 41, 24, 0, 14146 }, { 41, 24, 0, 14146 }, { 41, 24, 0, 14146 }, 
    { 38, 36, 1, 14146 }, { 38, 36, 1, 14146 }, { 38, 36, 1, 14146 }, 
    { 20, 37, 2, 14146 }, { 20, 37, 2, 14146 }, { 20, 37, 2, 14146 },
    { 18, 25, 3, 14146 }, { 18, 25, 3, 14146 }, { 18, 25, 3, 14146 },
    { 29, 18, 4, 14146 }, { 29, 18, 4, 14146 }, { 29, 18, 4, 14146 }
}

x893069_g_DogfaceGroup = 0					-- ÌÓÅÜĞ¡±øµÄ Group ID

--AI Index....
x893069_IDX_StopWatch						= 1	--Ãë±í....
x893069_IDX_SkillA_CD						= 2	--A¼¼ÄÜµÄCDÊ±¼ä....
x893069_IDX_SkillB_HPStep				= 3	--ÑªÁ¿¼¶±ğ....
x893069_IDX_SkillB_Step					= 4	--B¼¼ÄÜµÄStep....0=Î´·¢¶¯ 15=buff1 14=buff2 ¡­¡­ 1=buff15
x893069_IDX_SkillB_Type					= 5	--µ±Ç°ÕıÔÚÊ¹ÓÃÄÄÖÖÀàĞÍµÄ½£Îè....
x893069_IDX_SkillC_CD						= 6	--C¼¼ÄÜµÄCDÊ±¼ä....
x893069_IDX_SkillD_CD						= 7	--C¼¼ÄÜµÄCDÊ±¼ä....
x893069_IDX_KuangBaoTimer				= 8	--¿ñ±©µÄ¼ÆÊ±Æ÷....


x893069_IDX_CombatFlag 			= 1	--ÊÇ·ñ´¦ÓÚÕ½¶·×´Ì¬µÄ±êÖ¾....
x893069_IDX_IsKuangBaoMode	= 2	--ÊÇ·ñ´¦ÓÚ¿ñ±©Ä£Ê½µÄ±êÖ¾....


--**********************************
--³õÊ¼»¯....
--**********************************
function x893069_OnInit(sceneId, selfId)
	--ÖØÖÃAI....
	x893069_ResetMyAI( sceneId, selfId )
end


--**********************************
--ĞÄÌø....
--**********************************
function x893069_OnHeartBeat(sceneId, selfId, nTick)

	--¼ì²âÊÇ²»ÊÇËÀÁË....
	if LuaFnIsCharacterLiving(sceneId, selfId) ~= 1 then
		return
	end

	--¼ì²âÊÇ·ñ²»ÔÚÕ½¶·×´Ì¬....
	if 0 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x893069_IDX_CombatFlag ) then
		return
	end

	--¿ñ±©×´Ì¬²»ĞèÒª×ßÂß¼­....
	if 1 == MonsterAI_GetBoolParamByIndex( sceneId, selfId, x893069_IDX_IsKuangBaoMode ) then
		return
	end

	--A¼¼ÄÜĞÄÌø....
	if 1 == x893069_TickSkillA( sceneId, selfId, nTick ) then
		return
	end

	--B¼¼ÄÜĞÄÌø....
	if 1 == x893069_TickSkillB( sceneId, selfId, nTick ) then
		return
	end

	--C¼¼ÄÜĞÄÌø....
	if 1 == x893069_TickSkillC( sceneId, selfId, nTick ) then
		return
	end

	--D¼¼ÄÜĞÄÌø....
	if 1 == x893069_TickSkillD( sceneId, selfId, nTick ) then
		return
	end

	--E¼¼ÄÜĞÄÌø....
	if 1 == x893069_TickSkillE( sceneId, selfId, nTick ) then
		return
	end

	--Ãë±íĞÄÌø....
	x893069_TickStopWatch( sceneId, selfId, nTick )

		local monstercount = GetMonsterCount( sceneId )
		local monsterId, GroupID, DogX, DogZ
		local x, z = GetLastPatrolPoint( sceneId, 0 )

		for i = 0, monstercount - 1 do
			monsterId = GetMonsterObjID( sceneId, i )
			GroupID = GetMonsterGroupID( sceneId, monsterId )

			if GroupID == x893069_g_DogfaceGroup
			 and LuaFnIsCharacterLiving( sceneId, monsterId ) == 1 then			-- ÅĞ¶Ï»î×ÅµÄĞ¡±øÊÇ·ñÌÓÅÜ³É¹¦
				DogX, DogZ = GetWorldPos( sceneId, monsterId )

				if (x - DogX) * (x - DogX) + (z - DogZ) * (z - DogZ) < 2 then	-- ÀëÖÕµã²»µ½ 5 Ã×
					LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, 22456, 0 ) --¼ÓÑª
					LuaFnDeleteMonster( sceneId, monsterId )
				end
			end
		end
end


--**********************************
--½øÈëÕ½¶·....
--**********************************
function x893069_OnEnterCombat(sceneId, selfId, enmeyId)

	--¼Ó³õÊ¼buff....
	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x893069_Buff_MianYi1, 0 )
	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x893069_Buff_MianYi2, 0 )

	--ÖØÖÃAI....
	x893069_ResetMyAI( sceneId, selfId )

	--ÉèÖÃ½øÈëÕ½¶·×´Ì¬....
	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x893069_IDX_CombatFlag, 1 )

end


--**********************************
--Àë¿ªÕ½¶·....
--**********************************
function x893069_OnLeaveCombat(sceneId, selfId)

	--ÖØÖÃAI....
	x893069_ResetMyAI( sceneId, selfId )

	--É¾³ı×Ô¼º....
	LuaFnDeleteMonster( sceneId, selfId )
	--´´½¨¶Ô»°NPC....
	local MstId = CallScriptFunction( x893069_g_FuBenScriptId, "CreateBOSS", sceneId, "LiFan_NPC", -1, -1 )
	SetUnitReputationID( sceneId, MstId, MstId, 0 )
end


--**********************************
--É±ËÀµĞÈË....
--**********************************
function x893069_OnKillCharacter(sceneId, selfId, targetId)

end


--**********************************
--ËÀÍö....
--**********************************
function x893069_OnDie( sceneId, selfId, killerId )

	--ÖØÖÃAI....
	x893069_ResetMyAI( sceneId, selfId )

	--ÉèÖÃÒÑ¾­ÌôÕ½¹ıÀîÇïË®....
	CallScriptFunction( x893069_g_FuBenScriptId, "SetBossBattleFlag", sceneId, "PangQi", 2 )

	-- zchw È«Çò¹«¸æ
	local	playerName	= GetName( sceneId, killerId )
	
	--É±ËÀ¹ÖÎïµÄÊÇ³èÎïÔò»ñÈ¡ÆäÖ÷ÈËµÄÃû×Ö....
	local playerID = killerId
	local objType = GetCharacterType( sceneId, killerId )
	if objType == 3 then
		playerID = GetPetCreator( sceneId, killerId )
		playerName = GetName( sceneId, playerID )
	end
	
	--Èç¹ûÍæ¼Ò×é¶ÓÁËÔò»ñÈ¡¶Ó³¤µÄÃû×Ö....
	local leaderID = GetTeamLeader( sceneId, playerID )
	if leaderID ~= -1 then
		playerName = GetName( sceneId, leaderID )
	end
	
	if playerName ~= nil then
		str = format("#ccc33cc[KÏ Tr§n]#c99ccff là bí bäo mà Bàng Xí dùng ğ¬ chiªm TÑ Tuy®t Trang, chÆng nhæng b¸ #{_INFOUSR%s} cùng ğµi ngû phá hüy mà bän thân Bàng Xí cûng không giæ n±i tính mÕng cüa mình!", playerName); --ÀîÇïË®
		AddGlobalCountNews( sceneId, str )
	end

	CallScriptFunction((200060), "Paopao",sceneId, "Phan Tinh Tinh", "TÑ Tuy®t Trang","Các ngß¶i trong lúc ğánh nhau v¾i Bàng Xí ğã vô ı ğøng phäi c½ quan m§t ¦n dß¾i ğ¤t, phía trß¾c li«n xu¤t hi®n TÑ Tuy®t Bäo Sß½ng, có l¨ là báu v§t quı giá lâu nåm · TÑ Tuy®t Trang, mau mau giành l¤y!" )

		local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
		for i=0, nHumanCount-1 do
			local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
			if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then
				x,z = GetWorldPos( sceneId, nHumanId )
				local nBoxId = LuaFnCreateMonster(sceneId, 14156, x, z, 3, 0, 893082)
				SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
			end
		end

	--local x,z = GetWorldPos( sceneId, selfId )
	--local nBoxId = LuaFnCreateMonster(sceneId, 14156, x, z, 3, 0, 893082)
	--SetUnitCampID(sceneId, nBoxId, nBoxId, 0)
	
end


--**********************************
--ÖØÖÃAI....
--**********************************
function x893069_ResetMyAI( sceneId, selfId )

	--ÖØÖÃ²ÎÊı....
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_StopWatch, 0 )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillA_CD, 0 )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_HPStep, 0 )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step, 0 )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Type, 1 )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillC_CD, x893069_SkillC_CD )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillD_CD, x893069_SkillD_CD )
	MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_KuangBaoTimer, 0 )

	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x893069_IDX_CombatFlag, 0 )
	MonsterAI_SetBoolParamByIndex( sceneId, selfId, x893069_IDX_IsKuangBaoMode, 0 )

end

--**********************************
--A¼¼ÄÜĞÄÌø....
--**********************************
function x893069_TickSkillA( sceneId, selfId, nTick )

	--¸üĞÂ¼¼ÄÜCD....
	local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillA_CD )
	if cd > nTick then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillA_CD, cd-nTick )
		return 0
	else
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillA_CD, x893069_SkillA_CD-(nTick-cd) )
		return x893069_UseSkillA( sceneId, selfId )
	end

end

--**********************************
--B¼¼ÄÜĞÄÌø....
--**********************************
function x893069_TickSkillB( sceneId, selfId, nTick )

	local CurPercent = GetHp( sceneId, selfId ) / GetMaxHp( sceneId, selfId )
	local LastStep = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_HPStep )
	local CurStep = 0
	if CurPercent <= 0.1333 then
		CurStep = 5
	elseif CurPercent <= 0.3666 then
		CurStep = 4
	elseif CurPercent <= 0.6666 then
		CurStep = 3
	elseif CurPercent <= 0.8333 then
		CurStep = 2
	elseif CurPercent <= 0.9333 then
		CurStep = 1
	end

	if CurStep > LastStep and CurStep < 3 then

		--ÉèÖÃ²ÎÊı....
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_HPStep, CurStep )
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step, 2 )
		local JianWuType = random( getn(x893069_SkillB_SkillIDTbl) )
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Type, JianWuType )

		--º°»°....
		MonsterTalk(sceneId, -1, "", x893069_SkillB_TalkTbl[JianWuType] )

		CallScriptFunction((200060), "Paopao",sceneId, "Phan Tinh Tinh", "TÑ Tuy®t Trang", x893069_SkillB_Text[JianWuType] )
		
		MonsterTalk(sceneId, -1, "", x893069_SkillB_Text[JianWuType] )
		--·ÅÈ«³¡¾°ÑÌ»¨....
		LuaFnSetSceneWeather(sceneId, x893069_SkillB_WeatherTbl[JianWuType], 30000 )

		--¶Ô×Ô¼ºÊ¹ÓÃ¿Õ¼¼ÄÜ....
		local x,z = GetWorldPos( sceneId, selfId )
		local MstId = CallScriptFunction( x893066_g_FuBenScriptId, "CreateBOSS", sceneId, x893069_SkillB_LongZhuTbl[JianWuType], x, z )
		SetCharacterDieTime( sceneId, MstId, 30000 )

		return 1

	elseif CurStep > LastStep and CurStep < 4 then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_HPStep, CurStep )

		local x,z = GetWorldPos( sceneId, selfId )
		LuaFnUnitUseSkill( sceneId, selfId, x893069_SkillG_ID, selfId, x, z, 0, 1 )
		CallScriptFunction((200060), "Paopao",sceneId, "Phan Tinh Tinh", "TÑ Tuy®t Trang", "Phäi nhanh tay ğánh chªt tinh la ti¬u tØ, nªu không Bàng Xí s¨ phøc h°i tr· lÕi, lúc ğó e r¢ng ta cûng chÆng ğßşc bình yên ra khöi n½i này næa ğâu...")

		local dogfaceId = -1
		for i = 1, getn( x893069_g_DogfacePos ) do
			if x893069_g_DogfacePos[i] then
				dogfaceId = LuaFnCreateMonster( sceneId, x893069_g_DogfacePos[i][4], x893069_g_DogfacePos[i][1], x893069_g_DogfacePos[i][2], 1, 4, -1 )
				SetMonsterGroupID( sceneId, dogfaceId, x893069_g_DogfaceGroup )
				SetPatrolId( sceneId, dogfaceId, x893069_g_DogfacePos[i][3] )		-- ÉèÖÃÑ²ÂßÂ·¾¶
				SetCharacterDieTime( sceneId, dogfaceId, 8000 )
			end
		end

		return 1

	elseif CurStep > LastStep then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_HPStep, CurStep )

	--Ê¹ÓÃ¿Õ¼¼ÄÜ....
		local x,z = GetWorldPos( sceneId, selfId )
		LuaFnUnitUseSkill( sceneId, selfId, x893069_SkillF_ID, selfId, x, z, 0, 1 )
		CallScriptFunction((200060), "Paopao",sceneId, "Bàng Xí", "TÑ Tuy®t Trang", "Th§p bµ sát nh¤t nhân, vÕn d£m b¤t lßu hành...")
		CallScriptFunction((200060), "Paopao",sceneId, "Phan Tinh Tinh", "TÑ Tuy®t Trang", "Bàng Xí liên tøc phóng th§p ğÕi nh¤t cß¾c, m÷i ngß¶i chú ı coi ch×ng cÕm bçy dß¾i trân mình ğó...")

		local SpecObj = random( getn(x893069_SkillF_SpecObjTbl) )

		local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
		for i=0, nHumanCount-1 do
			local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
			if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then
				x,z = GetWorldPos( sceneId, nHumanId )
				CreateSpecialObjByDataIndex(sceneId, selfId, x893069_SkillF_SpecObjTbl[SpecObj], x, z, 0)
			end
		end

		return 1

	end

	return 0

end

--**********************************
--C¼¼ÄÜĞÄÌø....
--**********************************
function x893069_TickSkillC( sceneId, selfId, nTick )

	--¸üĞÂ¼¼ÄÜCD....
	local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillC_CD )
	if cd > nTick then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillC_CD, cd-nTick )
		return 0
	else
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillC_CD, x893069_SkillC_CD-(nTick-cd) )
		return x893069_UseSkillC( sceneId, selfId )
	end

end

--**********************************
--D¼¼ÄÜĞÄÌø....
--**********************************
function x893069_TickSkillD( sceneId, selfId, nTick )

	--¸üĞÂ¼¼ÄÜCD....
	local cd = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillD_CD )
	if cd > nTick then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillD_CD, cd-nTick )
		return 0
	else
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillD_CD, x893069_SkillD_CD-(nTick-cd) )
		return x893069_UseSkillD( sceneId, selfId )
	end

end

--**********************************
--E¼¼ÄÜĞÄÌø....
--**********************************
function x893069_TickSkillE( sceneId, selfId, nTick )

	--Èç¹ûÕıÔÚÓÃB¼¼ÄÜÔòÏÈµÈ´ı....
	if MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step ) > 0 then
		return 0
	end

	--¼ì²âÊÇ·ñµ½ÁË¿ñ±©µÄÊ±ºò....
	local kbTime = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_KuangBaoTimer )
	if kbTime < x893069_EnterKuangBaoTime then

		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_KuangBaoTimer, kbTime+nTick )
		return 0

	else

		MonsterAI_SetBoolParamByIndex( sceneId, selfId, x893069_IDX_IsKuangBaoMode, 1 )
		LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x893069_SkillE_Buff1, 0 )
		LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, x893069_SkillE_Buff2, 0 )
		return 1

	end

end

--**********************************
--Ãë±íĞÄÌø....
--**********************************
function x893069_TickStopWatch( sceneId, selfId, nTick )

	--ÏŞÖÆÃ¿Ãë²Å»áÖ´ĞĞÒ»´Î....
	local time = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_StopWatch )
	if (time + nTick) > 1000 then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_StopWatch, time+nTick-1000 )
	else
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_StopWatch, time+nTick )
		return
	end


	-------------------------
	--½£Îè¼¼ÄÜÂß¼­....
	-------------------------
	local buffStep = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step )
	local skillType = MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Type )
	if buffStep >= 1 and buffStep <= 2 then

		--Ñ°ÕÒ·ûÃôÒÇ....
		--local bossId = CallScriptFunction( x893069_g_FuBenScriptId, "FindBOSS", sceneId, "LiFan_NPC" )
		--if bossId <= 0 then
			--return 0
		--end

		--ÈÃ·ûÃôÒÇ¸øÍæ¼Ò¼Óbuff....
		local buffTbl = x893069_SkillB_BuffIDTbl[skillType]
		local buffId = buffTbl[2-buffStep]
		LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, selfId, buffId, 0 )
		--local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
		--for i=0, nHumanCount-1 do
			--local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
			--if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then
				--LuaFnSendSpecificImpactToUnit( sceneId, bossId, bossId, nHumanId, buffId, 0 )
			--end
		--end

	end

	if buffStep > 0 then
		MonsterAI_SetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step, buffStep-1 )
	end


end

--**********************************
--Ê¹ÓÃA¼¼ÄÜ....
--**********************************
function x893069_UseSkillA( sceneId, selfId )

	--Èç¹ûÕıÔÚÓÃB¼¼ÄÜÔòÌø¹ı....
	if MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step ) > 0 then
		return 0
	end

	--¶Ô×Ô¼ºÊ¹ÓÃÒ»¸ö¿Õ¼¼ÄÜ....
	local x,z = GetWorldPos( sceneId, selfId )
	LuaFnUnitUseSkill( sceneId, selfId, x893069_SkillA_BID, selfId, x, z, 0, 1 )

	--¸±±¾ÖĞÓĞĞ§µÄÍæ¼ÒµÄÁĞ±í....
	local PlayerList = {}

	--½«ÓĞĞ§µÄÈË¼ÓÈëÁĞ±í....
	local numPlayer = 0
	local nHumanCount = LuaFnGetCopyScene_HumanCount(sceneId)
	for i=0, nHumanCount-1 do
		local nHumanId = LuaFnGetCopyScene_HumanObjId(sceneId, i)
		if LuaFnIsObjValid(sceneId, nHumanId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, nHumanId) == 1 and LuaFnIsCharacterLiving(sceneId, nHumanId) == 1 then
			PlayerList[numPlayer+1] = nHumanId
			numPlayer = numPlayer + 1
		end
	end

	--Ëæ»úÌôÑ¡Ò»¸öÍæ¼Ò....
	if numPlayer <= 0 then
		return 0
	end
	local PlayerId = PlayerList[ random(numPlayer) ]

	--¶Ô×Ô¼ºÊ¹ÓÃÒ»¸ö¿Õ¼¼ÄÜ....
	local x,z = GetWorldPos( sceneId, selfId )
	LuaFnUnitUseSkill( sceneId, selfId, x893069_SkillA_ID, selfId, x, z, 0, 1 )

	--¸øÍæ¼Ò¼ÓÊ§Ã÷buff....
	LuaFnSendSpecificImpactToUnit( sceneId, selfId, selfId, PlayerId, x893069_SkillA_Buff, 0 )

	return 1

end

--**********************************
--Ê¹ÓÃC¼¼ÄÜ....
--**********************************
function x893069_UseSkillC( sceneId, selfId )

	--Èç¹ûÕıÔÚÓÃB¼¼ÄÜÔòÌø¹ı....
	if MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step ) > 0 then
		return 0
	end

	local x,z = GetWorldPos( sceneId, selfId )
	LuaFnUnitUseSkill( sceneId, selfId, x893069_SkillC_ID, selfId, x, z, 0, 1 )
	return 1

end

--**********************************
--Ê¹ÓÃD¼¼ÄÜ....
--**********************************
function x893069_UseSkillD( sceneId, selfId )

	--Èç¹ûÕıÔÚÓÃB¼¼ÄÜÔòÌø¹ı....
	if MonsterAI_GetIntParamByIndex( sceneId, selfId, x893069_IDX_SkillB_Step ) > 0 then
		return 0
	end

	--Ê¹ÓÃ¿Õ¼¼ÄÜ....
	local x,z = GetWorldPos( sceneId, selfId )
	LuaFnUnitUseSkill( sceneId, selfId, x893069_SkillD_ID, selfId, x, z, 0, 1 )

	return 1

end
