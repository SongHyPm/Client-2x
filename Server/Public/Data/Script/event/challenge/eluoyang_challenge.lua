-- ¸÷ÀŞÌ¨¶ÔÓ¦toÕ ğµ  ½Å±¾

x806012_g_ScriptId = 806012

x806012_g_GlobalChallengeScript = 806010

-- ¸±±¾³¡¾°
x806012_g_CopyScene = "leitai_2.nav"

-- ¸±±¾³ö¿Ú
x806012_g_CopySceneExit = "leitai_2_area.ini"

-- ¸±±¾µÇÂ½µØ ği¬m
x806012_g_Pos = { x=31, z=32, offset=3.53 }

-- ¸±±¾ÎŞÈËÊ±¹Ø±ÕÊ±¼ä (ºÁ giây)
x806012_g_CopySceneCloseTime = 3000

-- ¸±±¾¶¨Ê±Æ÷´¥·¢ÖÜÆÚ (ºÁ giây)
x806012_g_TickTime = 5000

-- ÀŞÌ¨¿ªÊ¼Ê±¼ä
x806012_g_BeginTick = 3

-- ¸±±¾Ö»Ê£ÏÂmµt ·½Ê±toÕ ğµ ¹Ø±ÕÖÜÆÚ ( µ¥Î»Îª¶¨Ê±Æ÷´¥·¢ÖÜÆÚ )
x806012_g_CloseTick = 3

-- ¸±±¾Pvp¹æÔò
x806012_g_PvpRuler = 9	--zchw

-- ¸±±¾ÀàĞÍºÅ
x806012_g_CopySceneType = FUBEN_PVP_LEITAI

-- Khiêu chiªnË«·½ÕóÓªºÅ
x806012_g_Camp = { self=10, target=11 }

-- Khiêu chiªn½áÊøÒÔºó»Øµ½toÕ ğµ Î»ÖÃ
x806012_g_BackPos = { sceneId=0, x=90, z=180 }

-- ÎŞµĞ BUFF ~~~
x806012_g_Buff = 112

x806012_g_BuffID_ClearChgBodyBuff = 84
-- ÈÃ selfId (¼°¶ÓÓÑ) Khiêu chiªn targetId (¼°¶ÓÓÑ)
function x806012_DoChallenge( sceneId, selfId, targetId )

	-- ÏÈ´´½¨mµt cái¸±±¾,Èç¹û´´½¨³É¹¦,Ôò¼ÌĞø,·ñÔòTr· v«
	local CreatorGUID = LuaFnObjId2Guid( sceneId, selfId )
	local TargetGUID = LuaFnObjId2Guid( sceneId, targetId )
	LuaFnSetSceneLoad_Map( sceneId, x806012_g_CopyScene )						-- µØÍ¼Ğúng±ØĞëÑ¡È¡toÕ ğµ ,¶øÇÒ±ØĞëTÕi Config/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader( sceneId, CreatorGUID )
	LuaFnSetCopySceneData_NoUserCloseTime( sceneId, x806012_g_CopySceneCloseTime )
	LuaFnSetCopySceneData_PvpRuler( sceneId, x806012_g_PvpRuler )
	LuaFnSetCopySceneData_Timer( sceneId, x806012_g_TickTime )
	LuaFnSetCopySceneData_Param( sceneId, 0, x806012_g_CopySceneType )			-- ÉèÖÃ¸±±¾ÀàĞÍ
	LuaFnSetCopySceneData_Param( sceneId, 1, x806012_g_ScriptId )				-- ½«1ºÅÊı¾İÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼ş½Å±¾ºÅ
	LuaFnSetCopySceneData_Param( sceneId, 2, 0 )						-- ÉèÖÃ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊı
	LuaFnSetCopySceneData_Param( sceneId, 3, TargetGUID )				-- Khiêu chiªn¶ÔÊÖtoÕ ğµ  GUID
	LuaFnSetCopySceneData_Param( sceneId, 4, 0 )						-- ÉèÖÃ¸±±¾¹Ø±Õ±êÖ¾, 0¿ª·Å,1¹Ø±Õ
	LuaFnSetCopySceneData_Param( sceneId, 5, 0 )						-- ÉèÖÃÀë¿ªµ¹¼ÆÊ±´ÎÊı
	LuaFnSetCopySceneData_Param( sceneId, 6, 0 )						-- ±£´æ self ¶ÓÎéºÅÒÔ¼°ÕóÓªtoÕ ğµ Ê£ÓàÈËÊı TeamID * 10 + TeamMemberCount
	LuaFnSetCopySceneData_Param( sceneId, 7, 0 )						-- ±£´æ target ¶ÓÎéºÅÒÔ¼°ÕóÓªtoÕ ğµ Ê£ÓàÈËÊı TeamID * 10 + TeamMemberCount

	LuaFnSetSceneLoad_Area( sceneId, x806012_g_CopySceneExit )					-- ¼ÓÔØÀŞÌ¨³ö¿Ú

	local CopySceneID = LuaFnCreateCopyScene( sceneId )					-- ³õÊ¼»¯Íê³Éºóµ÷ÓÃ´´½¨¸±±¾º¯Êı
	if CopySceneID <= 0 then
		BeginEvent( sceneId )
			AddText( sceneId, "Lôi ğài ğã quá ch§t, không th¬ chÑa thêm ngß¶i ğªn thách ğ¤u" )
		EndEvent( sceneId )
		DispatchMissionTips( sceneId, selfId )
		DispatchMissionTips( sceneId, targetId )
		return
	end
	--¼ÇÂ¼Í³¼ÆĞÅÏ¢
	LuaFnAuditChallenge(sceneId, selfId, targetId)
end

function x806012_GetSelfTeamId( sceneId )
	return LuaFnGetCopySceneData_Param( sceneId, 6 ) / 10
end

function x806012_GetTargetTeamId( sceneId )
	return LuaFnGetCopySceneData_Param( sceneId, 7 ) / 10
end

function x806012_GetSelfMembersCount( sceneId )
	local selfInfo = LuaFnGetCopySceneData_Param( sceneId, 6 )
	selfInfo = selfInfo - selfInfo / 10 * 10

	if selfInfo < 0 then
		selfInfo = -selfInfo
	end

	return selfInfo
end

function x806012_ModifySelfMembersCount( sceneId, count )
	local selfInfo = LuaFnGetCopySceneData_Param( sceneId, 6 )

	if selfInfo < 0 then
		count = -count
	end

	LuaFnSetCopySceneData_Param( sceneId, 6, selfInfo + count )
end

function x806012_GetTargetMembersCount( sceneId )
	local TargetInfo = LuaFnGetCopySceneData_Param( sceneId, 7 )
	TargetInfo = TargetInfo - TargetInfo / 10 * 10

	if TargetInfo < 0 then
		TargetInfo = -TargetInfo
	end

	return TargetInfo
end

function x806012_ModifyTargetMembersCount( sceneId, count )
	local TargetInfo = LuaFnGetCopySceneData_Param( sceneId, 7 )

	if TargetInfo < 0 then
		count = -count
	end

	LuaFnSetCopySceneData_Param( sceneId, 7, TargetInfo + count )
end

function x806012_CalcPosOffset()
	local offset = x806012_g_Pos.offset * random(100) / 100

	if random(0, 1) > 0 then
		offset = -offset
	end

	return offset
end

--**********************************
--¸±±¾ÊÂ¼ş
--**********************************
function x806012_OnCopySceneReady( sceneId, destsceneId )

	-- ÒÔÏÂ ğÕt ğßşcmµt cáiÍêÕûtoÕ ğµ C¥n ½øÈëĞÂÇøÓòtoÕ ğµ ÈËÔ±ÁĞ±í
	local selfId = LuaFnGuid2ObjId( sceneId, LuaFnGetCopySceneData_TeamLeader(destsceneId) )
	local targetId = LuaFnGuid2ObjId( sceneId, LuaFnGetCopySceneData_Param( destsceneId, 3 ) )
	local ChallengeFlag = GetMissionData( sceneId, selfId, MD_TIAOZHAN_SCRIPT )
	local selfCampCount = 0
	local targetCampCount = 0
	local num = 0
	local members = {}
	local membersCount = 0

	-- ½«Á½±ßtoÕ ğµ ¶ÓÎéºÅ±£´æÆğÀ´
	LuaFnSetCopySceneData_Param( destsceneId, 6, 10 * GetTeamId( sceneId, selfId ) )
	LuaFnSetCopySceneData_Param( destsceneId, 7, 10 * GetTeamId( sceneId, targetId ) )

	-- ½«·ûºÏ´«ËÍÌõ¼ştoÕ ğµ Íæ¼Ò×éºÏÆğÀ´
	members[0] = selfId
	membersCount = 1
	if LuaFnHasTeam( sceneId, selfId ) ~= 0 then
		num = LuaFnGetTeamSceneMemberCount( sceneId, selfId )
		for	i=0, num-1 do
			members[membersCount] = LuaFnGetTeamSceneMember( sceneId, selfId, i )

			if GetMissionData( sceneId, members[membersCount], MD_TIAOZHAN_SCRIPT ) == ChallengeFlag then
				membersCount = membersCount + 1
			end
		end
	end

	members[membersCount] = targetId
	membersCount = membersCount + 1
	if LuaFnHasTeam( sceneId, targetId ) ~= 0 then
		num = LuaFnGetTeamSceneMemberCount( sceneId, targetId )
		for	i=0, num-1 do
			members[membersCount] = LuaFnGetTeamSceneMember( sceneId, targetId, i )

			if GetMissionData( sceneId, members[membersCount], MD_TIAOZHAN_SCRIPT ) == ChallengeFlag then
				membersCount = membersCount + 1
			end
		end
	end

	for i=0, membersCount-1 do
		-- TODO: Ä¿Ç°ĞúngÓĞ±ê¼Ç¾Í´«ËÍ¹ıÈ¥,½«ÒªÅĞ¶ÏĞúng·ñ´¦ÓÚmµt Ğ©ÌØ¶¨×´Ì¬,±ÈÈç½»Ò×¡¢°ÚÌ¯µÈµÈ×´Ì¬Ğúng²»ÄÜ´«ËÍtoÕ ğµ 
		if LuaFnIsCanDoScriptLogic( sceneId, members[i] ) == 1 then
			NewWorld( sceneId, members[i], destsceneId, x806012_g_Pos.x + x806012_CalcPosOffset(), x806012_g_Pos.z + x806012_CalcPosOffset())
		end
	end
end

--  ğÕt ğßşc×Ô¼ºÕ¾TÕi ÄÄ·½toÕ ğµ ĞÅÏ¢,1: Khiêu chiªn·½,2: ±»Khiêu chiªn·½
function x806012_GetMySide( sceneId, selfId )
	local MyGUID = LuaFnObjId2Guid( sceneId, selfId )

	local ChallengerGUID = LuaFnGetCopySceneData_TeamLeader( sceneId )
	local targetGUID = LuaFnGetCopySceneData_Param( sceneId, 3 )

	local MySide = 0

	if targetGUID < 0 then
		targetGUID = targetGUID + 4294967296
	end

	if MyGUID == ChallengerGUID then
		MySide = 1
	elseif MyGUID == targetGUID then
		MySide = 2
	else
		local MyTeamId = GetTeamId( sceneId, selfId )
		local selfTeamId = x806012_GetSelfTeamId( sceneId )
		local targetTeamId = x806012_GetTargetTeamId( sceneId )

		if MyTeamId == selfTeamId then
			MySide = 1
		else	-- ³öÁËÎÊÌâ¾Í±ãÒË±»Khiêu chiªnÕßÁË,ºÇºÇ
			MySide = 2
		end
	end

	return MySide
end

--**********************************
--ÓĞÍæ¼Ò½øÈë¸±±¾ÊÂ¼ş
--**********************************
function x806012_OnPlayerEnter( sceneId, selfId )
	-- ÉèÖÃÍæ¼ÒÕóÓªºÅ,Èç¹ûÍæ¼ÒtoÕ ğµ  GUID µÈÓÚKhiêu chiªn·½»ò±»Khiêu chiªn·½ GUID,ÔòÖ±½ÓÉèÖÃÏàÓ¦ÕóÓªºÅ
	-- ·ñÔòÍæ¼ÒÓ¦¸ÃÊôÓÚÄ³mµt ·½toÕ ğµ ¶ÓÎé,Èç¹û¶ÓÎéºÅÏàµÈ,Ôò¸³Óè¸Ã¶ÓÎéºÅ¶ÔÓ¦toÕ ğµ ÕóÓªºÅ
	SetMissionData( sceneId, selfId, MD_PREV_CAMP, GetCurCamp(sceneId, selfId) )

	local MySide = x806012_GetMySide( sceneId, selfId )
	if MySide == 1 then
		SetUnitCampID( sceneId, selfId, selfId, x806012_g_Camp.self )
		SetPvpAuthorizationFlagByID(sceneId, selfId, 2, 1) --2Ğúng¾º¼¼ÊÚÈ¨±ê¼Ç
	--	x806012_ModifySelfMembersCount( sceneId, 1 )
	else
		SetUnitCampID( sceneId, selfId, selfId, x806012_g_Camp.target )
		SetPvpAuthorizationFlagByID(sceneId, selfId, 2, 1) --2Ğúng¾º¼¼ÊÚÈ¨±ê¼Ç
	--	x806012_ModifyTargetMembersCount( sceneId, 1 )
	end

	-- ¼ÓÉÏ 15  giâytoÕ ğµ  buff,Ò²ĞíÓ¦¸Ã·ÅTÕi  NewWorld ÒÔÇ°,Ö÷Òªº¦ÅÂÈç¹û NewWorld th¤t bÕi¿ÉÄÜ»áÓĞmµt Ğ©¸±×÷ÓÃ
	LuaFnSendSpecificImpactToUnit(sceneId, selfId, selfId, selfId, x806012_g_Buff, 0)

	-- ÉèÖÃÄ¬ÈÏ»¹»ê ği¬mÎª½øÈë³¡¾°toÕ ğµ ÀŞÌ¨
	SetPlayerDefaultReliveInfo( sceneId, selfId, "%10", -1, "0", x806012_g_BackPos.sceneId, x806012_g_BackPos.x, x806012_g_BackPos.z )
	-- ½øÈëĞ£³¡¸±±¾toÕ ğµ Íæ¼ÒÒªÇå³ı±äÉíbuff,·ÀÖ¹²»ÄÜ²Ù×÷±»´òËÀ
	LuaFnSendSpecificImpactToUnit(sceneId, selfId, selfId, selfId, x806012_g_BuffID_ClearChgBodyBuff, 0)
end

-- ¸±±¾³ö¿ÚÀë¿ªµ÷ÓÃCái này º¯Êı
function x806012_LeaveScene( sceneId, selfId )
	-- Í³¼ÆÊ£ÓàÈËÊı
	--local MySide = x806012_GetMySide( sceneId, selfId )
	--if MySide == 1 then
	--	x806012_ModifySelfMembersCount( sceneId, -1 )
	--else
	--	x806012_ModifyTargetMembersCount( sceneId, 1 )
	--end
	SetUnitCampID(sceneId, selfId, selfId, -1)
	SetPvpAuthorizationFlagByID(sceneId, selfId, 2, 0) --2Ğúng¾º¼¼ÊÚÈ¨±ê¼Ç

	--LuaFnDelApplyCamp( sceneId, selfId )
	LuaFnSendSpecificImpactToUnit(sceneId, selfId, selfId, selfId, 83 , 0);
	CallScriptFunction( (400900), "TransferFunc", sceneId, selfId, x806012_g_BackPos.sceneId, x806012_g_BackPos.x, x806012_g_BackPos.z )
end

--**********************************
--ÓĞÍæ¼ÒTÕi ¸±±¾ÖĞËÀÍöÊÂ¼ş
--**********************************
function x806012_OnHumanDie( sceneId, selfId, killerId )
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼ş
--**********************************
function x806012_OnCopySceneTimer( sceneId, nowTime )
	-- ¸±±¾Ê±ÖÓÉèÖÃ
	local tick = LuaFnGetCopySceneData_Param( sceneId, 2 )
	tick = tick + 1
	LuaFnSetCopySceneData_Param( sceneId, 2, tick + 1 )		-- ÉèÖÃĞÂtoÕ ğµ ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊı

	-- ¸±±¾¹Ø±Õ±êÖ¾
	leaveFlag = LuaFnGetCopySceneData_Param( sceneId, 4 )
	if leaveFlag == 1 then																			-- C¥n Àë¿ª
		-- Àë¿ªµ¹¼ÆÊ±¼ätoÕ ğµ ¶ÁÈ¡ºÍÉèÖÃ
		local leaveTickCount = LuaFnGetCopySceneData_Param( sceneId, 5 )
		leaveTickCount = leaveTickCount + 1
		LuaFnSetCopySceneData_Param( sceneId, 5, leaveTickCount + 1 )

		if x806012_g_CloseTick <= leaveTickCount then
			-- ½«µ±Ç°¸±±¾³¡¾°ÀïtoÕ ğµ ËùÓĞÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòtoÕ ğµ ³¡¾°
			local membercount = LuaFnGetCopyScene_HumanCount( sceneId )
			for	i=0, membercount-1 do
				local playerId = LuaFnGetCopyScene_HumanObjId( sceneId, i )
				if LuaFnIsObjValid( sceneId, playerId ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, playerId ) == 1 then
					x806012_LeaveScene( sceneId, playerId )
				end
			end
		else
			-- Í¨ÖªÊ£ÓàÍæ¼Ò¸±±¾¼´½«¹Ø±Õ
			local membercount = LuaFnGetCopyScene_HumanCount( sceneId )
	  		local strText = format( "Lôi ğài s¨ ğóng cØa trong vòng %d giây næa", (x806012_g_CloseTick-leaveTickCount)*x806012_g_TickTime/1000 )
	  		BeginEvent( sceneId )
	  			AddText( sceneId, strText )
	  		EndEvent( sceneId )

			for	i=0, membercount-1 do
				local member = LuaFnGetCopyScene_HumanObjId( sceneId, i )
				if LuaFnIsObjValid( sceneId, member ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, member ) == 1 then
	  			DispatchMissionTips( sceneId, member )
				end
			end
		end
	elseif tick > x806012_g_BeginTick then
		-- Í³¼ÆË«·½ÈËÔ±ÊıÁ¿,µ±mµt ·½ÎŞÈËÊ±,Ôò¹Ø±Õ¸±±¾,²»¿¼ÂÇ¶ÏÏß
		local membercount = LuaFnGetCopyScene_HumanCount( sceneId )
		local selfCount = 0
		local targetCount = 0

		for	i=0, membercount-1 do
			local playerId = LuaFnGetCopyScene_HumanObjId( sceneId, i )
			if LuaFnIsObjValid( sceneId, playerId ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, playerId ) == 1 then
	  		if x806012_GetMySide( sceneId, playerId ) == 1 then
	  			selfCount = selfCount + 1
	  		else
	  			targetCount = targetCount + 1
	  		end
			end
		end

		if selfCount < 1 or targetCount < 1 then
			LuaFnSetCopySceneData_Param( sceneId, 4, 1 )
		else
			return
		end

	  	local strText = "Kªt thúc thi ğ¤u, lôi ğài s¡p ğóng cØa"
	  	BeginEvent( sceneId )
	  		AddText( sceneId, strText )
	  	EndEvent( sceneId )

		for	i=0, membercount-1 do
			local playerId = LuaFnGetCopyScene_HumanObjId( sceneId, i )
			if LuaFnIsObjValid( sceneId, playerId ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, playerId ) == 1 then
	  		DispatchMissionTips( sceneId, playerId )
			end
		end
	else
		local membercount = LuaFnGetCopyScene_HumanCount( sceneId )

		local strText = ""

		if tick < x806012_g_BeginTick then
			strText = format( "Thi ğ¤u s¨ b¡t ğ¥u trong %d giây næa", (x806012_g_BeginTick-tick)*x806012_g_TickTime/1000 )
		else
			strText = "Thi ğ¤u chính thÑc b¡t ğ¥u"
		end

		BeginEvent(	sceneId )
			AddText( sceneId, strText )
		EndEvent( sceneId )

		for	i=0, membercount-1 do
			local playerId = LuaFnGetCopyScene_HumanObjId( sceneId, i )
			if LuaFnIsObjValid( sceneId, playerId ) == 1 and LuaFnIsCanDoScriptLogic( sceneId, playerId ) == 1 then
				DispatchMissionTips( sceneId, playerId )
			end
		end

	end

end
