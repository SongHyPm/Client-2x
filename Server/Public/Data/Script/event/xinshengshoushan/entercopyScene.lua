--ÐÂÐþÎäµºÈë¿Ú¶Ô»°½Å±¾
--

x808121_g_scriptId = 808121

x808121_tipinbox = 1
x808121_g_limitMembers = 3        --ÈËÊýÏÞÖÆ
x808121_g_Low_Level = 85           --µÈc¤pÏÞÖÆ
x808121_g_Low_Level_xinfa = 50           --ÐÄ·¨ÏÞÖÆ
x808121_g_NoUserTime = 3              --¸±±¾ÖÐÃ»ÓÐÈËºó¿ÉÒÔ¼ÌÐø±£´ætoÕ ðµ Ê±¼ä(µ¥Î»:  giây),²»ÖªµÀCái này Öµ¶Ô²»¶Ô?
x808121_g_tickDiffTime = 1              --»Øµ÷½Å±¾toÕ ðµ Ê±ÖÓÊ±¼ä(µ¥Î»:  giây/´Î)
x808121_g_CopySceneType = FUBEN_XINSHENGSHOUSHAN        --¸±±¾ÀàÐÍ,¶¨ÒåTÕi ScriptGlobal.luaÀïÃæ

x808121_g_FubenTbl =
{
	FubenName = "ÐÂÐþÎäµº",
	MapFile = "petisland_3.nav",
	monsterId = 3290,
	bossId = 3893,  --»¤µºÉñÊÞ
	AreaFile = "petisland_3_area.ini", 
	MonsterFile = "petisland_3_monster.ini",
	Fuben_start_x = 94,
	Fuben_start_z = 77,
}

x808121_monster_chufeng = {ID = 13281, Aitype = 0, AiscriptId = 0, scriptId = 808121, name = "³ÉÄê³û·ï"}     --³û·ï
x808121_monster_leilin = {ID = 13280, Aitype = 0, AiscriptId = 0, scriptId = 808121, name = "³ÉÄêÀ×÷ë"}      --À×÷ë
x808121_monster_xudaoshenshou = {ID = 13286, Aitype = 0, AiscriptId = 136, scriptId = 808121, name = "»¤µºÉñÊÞ"}   --»¤µºÉñÊÞ
x808121_monster_feitianmao = {ID = 13287, Aitype = 0, AiscriptId = 270, scriptId = 808121, name = "Vô Ð¸ch Phi Thiên Miêu"}   --Vô Ð¸ch Phi Thiên Miêu
x808121_monster_xiaozhuzhu = {ID = 13282, Aitype = 0, AiscriptId = 212, scriptId = 808121, name = "Ð¡ÖíÖí"}   --Ð¡ÖíÖí
x808121_monster_xiaohuhu = {ID = 13284, Aitype = 0, AiscriptId = 215, scriptId = 808121, name = "Ð¡»¢»¢"}   --Ð¡»¢»¢
x808121_monster_xiaoyingying = {ID = 13285, Aitype = 0, AiscriptId = 214, scriptId = 808121, name = "Ð¡Ó¥Ó¥"}   --Ð¡Ó¥Ó¥
x808121_monster_xiaogougou = {ID = 13283, Aitype = 0, AiscriptId = 213, scriptId = 808121, name = "Ð¡¹·¹·"}   --Ð¡¹·¹·
x808121_monster_groupId = 1

x808121_monster_First_num = 15
x808121_monster_Second_num = 15
x808121_monster_Third_num = 15
x808121_monster_Fourth_num = 15
x808121_monster_boss_num = 6
 
x808121_gFirst_MonstersTbl =   --µÚmµt Åú¹Ö×ø±ê
{
{x = 127, z = 85}, {x = 126, z = 90}, {x = 130, z = 90}, {x = 137, z = 77}, {x = 137, z = 81}, {x = 141, z = 80}, {x = 149, z = 86}, {x = 152, z = 82}, {x = 140, z = 101}, 
{x = 157, z = 101}, {x = 134, z = 107}, {x = 145, z = 103}, {x = 154, z = 106}, {x = 147, z = 108}, {x = 160, z = 88}
}
x808121_gSecond_MonstersTbl =   --µÚ¶þÅú¹Ö×ø±ê
{
{x = 179, z = 86}, {x = 176, z = 89}, {x = 183, z = 100}, {x = 177, z = 95}, {x = 183, z = 92}, {x = 191, z = 122}, {x = 194, z = 128}, {x = 161, z = 108}, {x = 176, z = 116}, 
{x = 152, z = 119}, {x = 162, z = 124}, {x = 163, z = 132}, {x = 175, z = 135}, {x = 178, z = 128}, {x = 170, z = 127}
}
x808121_gThird_MonstersTbl =    --µÚÈýÅú¹Ö×ø±ê
{
{x = 193, z = 153}, {x = 188, z = 163}, {x = 195, z = 163}, {x = 201, z = 163}, {x = 200, z = 170}, {x = 194, z = 171}, {x = 171, z = 146}, {x = 174, z = 150}, {x = 159, z = 156}, 
{x = 162, z = 159}, {x = 157, z = 162}, {x = 149, z = 153}, {x = 147, z = 147}, {x = 152, z = 157}, {x = 161, z = 145}
}
x808121_gFourth_MonstersTbl =    --µÚËÄÅú¹Ö×ø±ê
{
{x = 137, z = 157}, {x = 130, z = 158}, {x = 140, z = 163}, {x = 124, z = 144}, {x = 121, z = 137}, {x = 126, z = 129}, {x = 141, z = 137}, {x = 138, z = 141}, {x = 101, z = 155}, 
{x = 108, z = 161}, {x = 111, z = 163}, {x = 109, z = 173}, {x = 107, z = 169}, {x = 133, z = 146}, {x = 128, z = 136}
}
x808121_gFourth_hudaoshenshouTbl =
{startx = 153, startz = 182, PatrolId = 0}

x808121_gFourth_feitianmaoTbl =
{startx = 155, startz = 150, PatrolId = 1}

x808121_gFourth_xiaozuzuTbl =
{startx = 155, startz = 150, PatrolId = 2}
x808121_gFourth_xiaohuhuTbl =
{startx = 155, startz = 150, PatrolId = 3}
x808121_gFourth_xiaoyingyingTbl =
{startx = 155, startz = 150, PatrolId = 4}
x808121_gFourth_xiaogougouTbl =
{startx = 155, startz = 150, PatrolId = 5}

--µôÂä
 -- Ëæ»úÒò×Ó
x808121_g_RandNum = 10000

 -- ³èÎïtoÕ ðµ ´æ»îÊ±¼ä,3 phút
x808121_g_Lifecycle = 180000

--**********************************
--ÈÎÎñÈë¿Úº¯Êý....
--**********************************
function x808121_OnDefaultEvent( sceneId, selfId, targetId )

--**********************************
--NPC¶Ô»°
--**********************************
	BeginEvent( sceneId )
		AddText(sceneId, "Thiên niên kì thúÒÑ¾­½µÁÙTÕi ÉñÃØtoÕ ðµ ÐþÎäµºÁË,È¥mµt ¶ giâyûÃÇtoÕ ðµ ·ç²É°É!")
		AddNumText( sceneId, x808121_g_scriptId, "entercopyScene 1", 6, 1 )
	EndEvent( sceneId )
	DispatchEventList( sceneId, selfId, targetId )

end


function x808121_OnEventRequest( sceneId, selfId, targetId, eventId )
	
	
	if GetNumText() == 1 then
		local nCheckRet = x808121_CheckCanEnterScene(sceneId, selfId, targetId, eventId)
		local strOutmsg = "";
		if (nCheckRet == 1) then
			strOutmsg = "ÏëKhiêu chiªnÆæÊÞ,Ngß½i c¥n mµt Ö§3ÈË»ò3ÈËÒÔÉÏtoÕ ðµ ¶ÓÎé.";
		elseif (nCheckRet == 2) then
			strOutmsg = "Ngß½i không phäi là ¶Ó³¤,ÇëÈÃCüa ngß½i ¶Ó³¤À´ÕÒÎÒ.";
		elseif (nCheckRet == 3) then
			strOutmsg = "ÏëKhiêu chiªnÆæÊÞ,Ngß½i c¥n mµt Ö§3ÈË»ò3ÈËÒÔÉÏtoÕ ðµ ¶ÓÎé."           --²»¹»ÈýÈË
		elseif (nCheckRet == 4) then
			strOutmsg = "Thành viên trong ðµi ngü ÓÐ³ÉÔ±²»TÕi ¸½½ü.";
		elseif (nCheckRet == 5 or nCheckRet == 6) then
			strOutmsg = "¶Ô²»Æð,Thành viên trong ðµi ngü ÓÐ³ÉÔ±Chßa ðü½øÈëÌõ¼þ.\n"           --5,6mµt ¶¨Ðúng¿òÏÔÊ¾
			
			local nearMemberCount = GetNearTeamCount(sceneId, selfId);
			local sceneMemId = 0;
			local memName = "";
			
			local strOutMsgTemp = {}
			for i = 0, nearMemberCount - 1 do
				sceneMemId = GetNearTeamMember(sceneId, selfId, i)
				memName = GetName(sceneId, sceneMemId);
				strOutMsgTemp[i] = "#c3c3cff"..memName.."#W"
				if sceneMemId and sceneMemId >= 0 then			
					if (GetLevel(sceneId, sceneMemId) < x808121_g_Low_Level) then
						strOutMsgTemp[i] = strOutMsgTemp[i]..":\n  µÈc¤pÒªÇó"..tostring(x808121_g_Low_Level).."    #cff0000Chßa ðü#W\n"
					else
						strOutMsgTemp[i] = strOutMsgTemp[i]..":\n  µÈc¤pÒªÇó"..tostring(x808121_g_Low_Level).."    #c00ff00Thöa mãn#W\n"
					end
					if (0 == x808121_CheckAllXinfaLevel(sceneId, sceneMemId)) then
						strOutMsgTemp[i] = strOutMsgTemp[i].."  ÐÄ·¨ÒªÇó"..tostring(x808121_g_Low_Level_xinfa).."    #cff0000Chßa ðü#W\n"
					else
						strOutMsgTemp[i] = strOutMsgTemp[i].."  ÐÄ·¨ÒªÇó"..tostring(x808121_g_Low_Level_xinfa).."    #c00ff00Thöa mãn#W\n"
					end
				else
					strOutMsgTemp[i] = strOutMsgTemp[i]..memName..":ÎÞ·¨ÕýÈ·»ñÈ¡³ÉÔ±ÐÆng c¤p tâm pháp ×ÊÁÏ."
				end
			end
			
			BeginEvent( sceneId )
				AddText(sceneId, strOutmsg)
				for i = 0, nearMemberCount - 1 do
					AddText(sceneId, strOutMsgTemp[i])
				end
			EndEvent( sceneId )
			DispatchEventList( sceneId, selfId, targetId )	
			
			return
		end			

		if (nCheckRet > 0 and nCheckRet < 5) then
			if (x808121_tipinbox == 1) then
				BeginEvent( sceneId )
		   			AddText(sceneId, strOutmsg)
		   		EndEvent( sceneId )
		  		DispatchEventList( sceneId, selfId, targetId )	
			else
				x808121_NotifyFailTips(sceneId, selfId, strOutmsg);
			end
			return
		end
		
		--¿ÉÒÔ½øÈë¸±±¾ÁË
		local nearMemberCount = GetNearTeamCount(sceneId, selfId);
		x808121_MakeCopyScene(sceneId, selfId, targetId, nearMemberCount)	

	end

end


--**********************************
--¼ì²éÐúng·ñThöa mãn½øÈë¸±±¾toÕ ðµ ÒªÇó

--¼ì²éÐúng·ñThöa mãn½øÈë¸±±¾toÕ ðµ ÒªÇó
--Tr· v«ÖµË ði¬m÷: 1     Ã»×é¶Ó
--            2     ²»Ðúng¶Ó³¤
--            3     ²»¹»ÈýÈË
--            4     Ðµi viên ²»TÕi ¸½½ü
--            5     ¶Ó³¤µÈc¤pÐÄ·¨²»¹»
--            6     Ðµi viên µÈc¤pÐÄ·¨²»¹»
--            7
--            0       Thöa mãn
--**********************************
function x808121_CheckCanEnterScene(sceneId, selfId, targetId, eventId)
	
	if LuaFnHasTeam(sceneId, selfId) == 0 then
		return 1
	end
	
	if LuaFnIsTeamLeader(sceneId, selfId) == 0 then
		return  2
	end
	
	local teamMemberCount = GetTeamMemberCount(sceneId, selfId);
	if not teamMemberCount or teamMemberCount < x808121_g_limitMembers then
		return  3
	end
	
	local nearMemberCount = GetNearTeamCount(sceneId, selfId);
	if not nearMemberCount or teamMemberCount ~= nearMemberCount then
		return 4
	end
	
	
	-- ¼ì²â¶Ó³¤toÕ ðµ µÈc¤pÐúng·ñThöa mãnÒªÇó
	if (GetLevel(sceneId, selfId) < x808121_g_Low_Level or 0 == x808121_CheckAllXinfaLevel(sceneId, selfId)) then
		return 5
	end
	
	-- Í³¼ÆÐúng·ñÓÐÐµi viên Chßa ðüµÈc¤pÐÄ·¨ÒªÇó
	local bHave = 0
	for i = 0, nearMemberCount - 1 do
		local sceneMemId = GetNearTeamMember(sceneId, selfId, i)
		if sceneMemId and sceneMemId >= 0 then			
			if (GetLevel(sceneId, sceneMemId) < x808121_g_Low_Level) then
				bHave = 1
			end
			if (0 == x808121_CheckAllXinfaLevel(sceneId, sceneMemId)) then
				bHave = 1
			end
		end
	end
	
	if(bHave == 1)then
		return 6;
	end
	 
--ÖÕÓÚThöa mãnÁË~~~
	return 0;
end



--**********************************
--´´½¨¸±±¾
--nearmembercount: Ðµi viên cáiÊý
--**********************************
function x808121_MakeCopyScene(sceneId, selfId, targetId, nearmembercount)

	local x
	local z
	x,z = LuaFnGetWorldPos(sceneId,selfId)
	local leaderguid = LuaFnObjId2Guid(sceneId, selfId);
	LuaFnSetSceneLoad_Map(sceneId, x808121_g_FubenTbl.MapFile);										--µØÍ¼Ðúng±ØÐëÑ¡È¡toÕ ðµ ,¶øÇÒ±ØÐëTÕi Config/SceneInfo.iniÀïÅäÖÃºÃ
	LuaFnSetCopySceneData_TeamLeader(sceneId, leaderguid);
	LuaFnSetCopySceneData_NoUserCloseTime(sceneId, x808121_g_NoUserTime * 1000);
	LuaFnSetCopySceneData_Timer(sceneId, x808121_g_tickDiffTime * 1000);
	
	--³õÊ¼»¯ËùÓÐ¸±±¾²ÎÊý
	for i=0, 31 do
		LuaFnSetCopySceneData_Param(sceneId, i, 0)
	end
	
	LuaFnSetCopySceneData_Param(sceneId, 0, x808121_g_CopySceneType);					--ÉèÖÃ¸±±¾Êý¾Ý,ÕâÀï½«0ºÅË÷ÒýtoÕ ðµ Êý¾ÝÉèÖÃÎª999,ÓÃÓÚ±íÊ¾¸±±¾ºÅ999(Êý×Ö×Ô¶¨Òå)
	LuaFnSetCopySceneData_Param(sceneId, 1, x808121_g_scriptId);						--½«1ºÅÊý¾ÝÉèÖÃÎª¸±±¾³¡¾°ÊÂ¼þ½Å±¾ºÅ
	LuaFnSetCopySceneData_Param(sceneId, 2, 0);											--ÉèÖÃ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	LuaFnSetCopySceneData_Param(sceneId, 3, -1);										--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ, ³õÊ¼»¯
	LuaFnSetCopySceneData_Param(sceneId, 4, x);											--Èë¿ÚµØÖ·
	LuaFnSetCopySceneData_Param(sceneId, 5, z);											
	LuaFnSetCopySceneData_Param(sceneId, 6, GetTeamId(sceneId, selfId));				--±£´æ¶ÓÎéºÅ
	LuaFnSetCopySceneData_Param(sceneId, 7, 0);											--É±ËÀÁú÷ëtoÕ ðµ ÊýÁ¿
	LuaFnSetCopySceneData_Param(sceneId, 8, x808121_g_FubenTbl.monsterId )	--Ð¡¹ÖID....
	LuaFnSetCopySceneData_Param(sceneId, 9, x808121_g_FubenTbl.bossId )		--BOSSID....
	LuaFnSetCopySceneData_Param(sceneId, 11, 0 )				--É±·ï³û¹ÖÊý....
	LuaFnSetCopySceneData_Param(sceneId, 12, 0 )				--step....
	LuaFnSetCopySceneData_Param(sceneId, 13, 0 )				--É±bossÊýÁ¿
	
	LuaFnSetSceneLoad_Area( sceneId, x808121_g_FubenTbl.AreaFile )
	LuaFnSetSceneLoad_Monster( sceneId, x808121_g_FubenTbl.MonsterFile )

	local bRetSceneID = LuaFnCreateCopyScene(sceneId)
	BeginEvent(sceneId)
		if bRetSceneID>0 then
			AddText(sceneId,"D¸ch chuy¬n thành công!");
			--É¾³ýNPC
			LuaFnDeleteMonster(sceneId, targetId)
		else
			AddText(sceneId,"S¯ lßþng bän sao ðã ðªn gi¾i hÕn, ð« ngh¸ lát næa thØ lÕi!");
		end
	EndEvent(sceneId)
	DispatchMissionTips(sceneId,selfId)
end

--**********************************
--Íæ¼ÒÍË³ö¸±±¾
--**********************************
function x808121_PlayerExit(sceneId, selfId)

	if selfId then
		local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3);		--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
		local x = LuaFnGetCopySceneData_Param(sceneId, 4);
		local z = LuaFnGetCopySceneData_Param(sceneId, 5);
		
		--½«µ±Ç°¸±±¾³¡¾°ÀïtoÕ ðµ ËùÓÐÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòtoÕ ðµ ³¡¾°
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, memId) == 1 then
				if memId == selfId then
					NewWorld(sceneId, memId, oldsceneId, x, z);
				end
			end
		end
	end
end

--**********************************
--¸±±¾ÊÂ¼þ
--**********************************
function x808121_OnCopySceneReady(sceneId, destsceneId)
	LuaFnSetCopySceneData_Param(destsceneId, 3, sceneId);		--ÉèÖÃ¸±±¾Èë¿Ú³¡¾°ºÅ
	local leaderguid  = LuaFnGetCopySceneData_TeamLeader(destsceneId);
	local leaderObjId = LuaFnGuid2ObjId(sceneId,leaderguid);
	local day = GetDayTime();

	if LuaFnIsCanDoScriptLogic(sceneId, leaderObjId) ~= 1 then
		return 
	end

	--È¡ ði¬mÍæ¼Ò¸½½ütoÕ ðµ ¶ÓÓÑÊýÁ¿(°üÀ¨×Ô¼º)
	local nearMemberCount = GetNearTeamCount(sceneId, leaderObjId) ;
	local memId;
	for	i = 0, nearMemberCount - 1 do
		memId = GetNearTeamMember(sceneId, leaderObjId, i);
		if LuaFnIsObjValid(sceneId, memId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, memId) == 1 then
			NewWorld(sceneId, memId, destsceneId, x808121_g_FubenTbl.Fuben_start_x, x808121_g_FubenTbl.Fuben_start_z);
		end
		--»î¶¯Í³¼ÆÏÖTÕi »¹²»C¥n 
	end
	
	--Í³¼Æ,¶Ó³¤´øÁË¶àÉÙÈË½øÈ¥(ÈËÊýÖÐ°üÀ¨¶Ó³¤)
	CreateCopySceneAudit(sceneId, leaderObjId, nearMemberCount)
end

--**********************************
--ÓÐÍæ¼Ò½øÈë¸±±¾ÊÂ¼þ
--**********************************
function x808121_OnPlayerEnter(sceneId, selfId)
	--ÉèÖ giâyÀÍöºó¸´»î ði¬mÎ»ÖÃ	
	SetPlayerDefaultReliveInfo(sceneId, selfId, "%10", -1, "0", sceneId, x808121_g_FubenTbl.Fuben_start_x, x808121_g_FubenTbl.Fuben_start_z);  --¸´»î ði¬mÉèÖÃTÕi ¸Õ½øÈëtoÕ ðµ µØ·½
	local teamLeaderFlag = LuaFnIsTeamLeader(sceneId, selfId);
	if teamLeaderFlag and teamLeaderFlag == 1 then
		LuaFnSetTeamExpAllotMode(sceneId, selfId, 0);      --Æ½¾ù·ÖÅäÄ£Ê½
	end
end

--**********************************
--ÓÐÍæ¼ÒTÕi ¸±±¾ÖÐËÀÍöÊÂ¼þ
--**********************************
function x808121_OnHumanDie(sceneId, selfId, killerId)
end

--**********************************
--¸±±¾³¡¾°¶¨Ê±Æ÷ÊÂ¼þ
--**********************************
function x808121_OnCopySceneTimer(sceneId, nowTime)

	--¸±±¾Ê±ÖÓ¶ÁÈ¡¼°ÉèÖÃ
	local nStep = LuaFnGetCopySceneData_Param(sceneId, 12 )
	local curTickCount = LuaFnGetCopySceneData_Param(sceneId, 2);		--È¡ ði¬mÒÑ¾­Ö´ÐÐtoÕ ðµ ¶¨Ê±´ÎÊý
	
	--½×¶Î¿ØÖÆ
	if (nStep == 0) then        --¸±±¾¸Õ¸Õ¿ªÊ¼
		LuaFnSetCopySceneData_Param(sceneId, 12, 1 )	
		
		LuaFnSetSceneWeather(sceneId, 19, 39*60*1000 );   --ÏÂÓê
		
		--ÌáÊ¾ÐÅÏ¢
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x808121_NotifyFailTips(sceneId, memId, "Thiên niên kì thú: À×÷ëÒÑ¾­½µÁÙµ½ÉñÃØtoÕ ðµ ÐþÎäµºÁË.");
 			end
		end		
		
		--³öÏÖµÚmµt Åú¹Ö
		for i, MonsterPos in x808121_gFirst_MonstersTbl do
			objId = LuaFnCreateMonster( sceneId, x808121_monster_leilin.ID, MonsterPos.x, MonsterPos.z, x808121_monster_leilin.Aitype, x808121_monster_leilin.AiscriptId , x808121_monster_leilin.scriptId )			
		end
		
		--½¨Á¢´óboss,»¤µºÉñÊÞ,
		objId = LuaFnCreateMonster( sceneId, x808121_monster_xudaoshenshou.ID, x808121_gFourth_hudaoshenshouTbl.startx, x808121_gFourth_hudaoshenshouTbl.startz, x808121_monster_xudaoshenshou.Aitype, x808121_monster_xudaoshenshou.AiscriptId , x808121_monster_xudaoshenshou.scriptId )			
		SetPatrolId(sceneId, objId, x808121_gFourth_hudaoshenshouTbl.PatrolId )
		--Vô Ð¸ch Phi Thiên Miêu
		objId = LuaFnCreateMonster( sceneId, x808121_monster_feitianmao.ID, x808121_gFourth_feitianmaoTbl.startx, x808121_gFourth_feitianmaoTbl.startz, x808121_monster_feitianmao.Aitype, x808121_monster_feitianmao.AiscriptId , x808121_monster_feitianmao.scriptId )			
		SetCharacterTitle(sceneId, objId, "ÐþÎäµºÕì¼©¶Ó³¤")
		SetMonsterGroupID(sceneId, objId, x808121_monster_groupId);	--Ã¿×é¹ÖÎïÊôÓÚÍ¬mµt cáiGroupID,ÕâÑù¹ÖÎïÃÇ¿ÉÒÔ»¥ÏàÔöÔ®
		SetPatrolId(sceneId, objId, x808121_gFourth_feitianmaoTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x808121_monster_xiaozhuzhu.ID, x808121_gFourth_xiaozuzuTbl.startx, x808121_gFourth_xiaozuzuTbl.startz, x808121_monster_xiaozhuzhu.Aitype, x808121_monster_xiaozhuzhu.AiscriptId , x808121_monster_xiaozhuzhu.scriptId )			
		SetMonsterGroupID(sceneId, objId, x808121_monster_groupId);
		SetPatrolId(sceneId, objId, x808121_gFourth_xiaozuzuTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x808121_monster_xiaohuhu.ID, x808121_gFourth_xiaohuhuTbl.startx, x808121_gFourth_xiaohuhuTbl.startz, x808121_monster_xiaohuhu.Aitype, x808121_monster_xiaohuhu.AiscriptId , x808121_monster_xiaohuhu.scriptId )			
		SetMonsterGroupID(sceneId, objId, x808121_monster_groupId);
		SetPatrolId(sceneId, objId, x808121_gFourth_xiaohuhuTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x808121_monster_xiaoyingying.ID, x808121_gFourth_xiaoyingyingTbl.startx, x808121_gFourth_xiaoyingyingTbl.startz, x808121_monster_xiaoyingying.Aitype, x808121_monster_xiaoyingying.AiscriptId , x808121_monster_xiaoyingying.scriptId )			
		SetMonsterGroupID(sceneId, objId, x808121_monster_groupId);
		SetPatrolId(sceneId, objId, x808121_gFourth_xiaoyingyingTbl.PatrolId )
		objId = LuaFnCreateMonster( sceneId, x808121_monster_xiaogougou.ID, x808121_gFourth_xiaogougouTbl.startx, x808121_gFourth_xiaogougouTbl.startz, x808121_monster_xiaogougou.Aitype, x808121_monster_xiaogougou.AiscriptId , x808121_monster_xiaogougou.scriptId )			
		SetMonsterGroupID(sceneId, objId, x808121_monster_groupId);
		SetPatrolId(sceneId, objId, x808121_gFourth_xiaogougouTbl.PatrolId )
		
	elseif (nStep == 4) then     --¹ÖËÀ¹âÁË
		curTickCount	= 2340
		LuaFnSetCopySceneData_Param(sceneId, 2, curTickCount);--ÉèÖÃÐÂtoÕ ðµ ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
		LuaFnSetCopySceneData_Param(sceneId, 12, 5 )   --½øÈëµ¹¼ÆÊ±ÁË	
	end
	
	--Ê±¼ä¿ØÖÆ
	local strOutMsg = ""
	--µÚ¶þÅú¹ÖÂß¼­
	if (curTickCount >=240 and curTickCount <= 300) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		
		if(curTickCount == 240) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ60 giâyºó½µÁÙ."
		elseif(curTickCount == 270) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ30 giâyºó½µÁÙ."
		elseif(curTickCount == 290) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ10 giâyºó½µÁÙ."
		elseif(curTickCount == 295) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ5 giâyºó½µÁÙ."
		elseif(curTickCount == 300) then
			strOutMsg = "Thiên niên kì thú: ³û·ïÒÑ¾­½µÁÙµ½ÉñÃØtoÕ ðµ ÐþÎäµºÁË."
			--³öÏÖµÚ¶þÅú¹Ö
			for i, MonsterPos in x808121_gSecond_MonstersTbl do
				objId = LuaFnCreateMonster( sceneId, x808121_monster_chufeng.ID, MonsterPos.x, MonsterPos.z, x808121_monster_chufeng.Aitype, x808121_monster_chufeng.AiscriptId , x808121_monster_chufeng.scriptId )			
			end
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x808121_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		
	
		--µÚÈýÅú¹ÖÂß¼­
	elseif (curTickCount >=540 and curTickCount <= 600) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		
		if(curTickCount == 540) then
			strOutMsg = "Thiên niên kì thú: À×÷ë½«ÓÚ60 giâyºó½µÁÙ."
		elseif(curTickCount == 570) then
			strOutMsg = "Thiên niên kì thú: À×÷ë½«ÓÚ30 giâyºó½µÁÙ."
		elseif(curTickCount == 590) then
			strOutMsg = "Thiên niên kì thú: À×÷ë½«ÓÚ10 giâyºó½µÁÙ."
		elseif(curTickCount == 595) then
			strOutMsg = "Thiên niên kì thú: À×÷ë½«ÓÚ5 giâyºó½µÁÙ."
		elseif(curTickCount == 600) then
			strOutMsg = "Thiên niên kì thú: À×÷ëÒÑ¾­½µÁÙµ½ÉñÃØtoÕ ðµ ÐþÎäµºÁË."
			--³öÏÖµÚÈýÅú¹Ö
			for i, MonsterPos in x808121_gThird_MonstersTbl do
				objId = LuaFnCreateMonster( sceneId, x808121_monster_leilin.ID, MonsterPos.x, MonsterPos.z, x808121_monster_leilin.Aitype, x808121_monster_leilin.AiscriptId , x808121_monster_leilin.scriptId )			
			end
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x808121_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		

	
	--µÚËÄÅú¹ÖÂß¼­
	elseif (curTickCount >=840 and curTickCount <= 900) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		
		if(curTickCount == 840) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ60 giâyºó½µÁÙ."
		elseif(curTickCount == 870) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ30 giâyºó½µÁÙ."
		elseif(curTickCount == 890) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ10 giâyºó½µÁÙ."
		elseif(curTickCount == 895) then
			strOutMsg = "Thiên niên kì thú: ³û·ï½«ÓÚ5 giâyºó½µÁÙ."
		elseif(curTickCount == 900) then
			strOutMsg = "Thiên niên kì thú: ³û·ïÒÑ¾­½µÁÙµ½ÉñÃØtoÕ ðµ ÐþÎäµºÁË."
			--³öÏÖµÚËÄÅú¹Ö
			for i, MonsterPos in x808121_gFourth_MonstersTbl do
				objId = LuaFnCreateMonster( sceneId, x808121_monster_chufeng.ID, MonsterPos.x, MonsterPos.z, x808121_monster_chufeng.Aitype, x808121_monster_chufeng.AiscriptId , x808121_monster_chufeng.scriptId )			
			end
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x808121_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		

	--40 phútµ½ÁËcurTickCount == 2400)
	elseif (curTickCount >=2340) then
		local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
		local memId;
		if (curTickCount == 2340) then
			strOutMsg = "Các hÕ s¨ r¶i khöi n½i này trong vòng 60 giây næa."
		elseif(curTickCount == 2370) then
			strOutMsg = "Các hÕ s¨ r¶i khöi n½i này trong vòng 30 giây næa."
		elseif(curTickCount == 2380) then
			strOutMsg = "Các hÕ s¨ r¶i khöi n½i này trong vòng 20 giây næa."
		elseif(curTickCount == 2390) then
			strOutMsg = "Các hÕ s¨ r¶i khöi n½i này trong vòng 10 giây næa."
		elseif(curTickCount == 2395) then
			strOutMsg = "Các hÕ s¨ r¶i khöi n½i này trong vòng 5 giây næa."
		elseif(curTickCount >= 2400) then
			local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3);		--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ,×¼±¸°ÑÍæ¼Ò´«³öÈ¥
			local x = LuaFnGetCopySceneData_Param(sceneId, 4);
			local z = LuaFnGetCopySceneData_Param(sceneId, 5);
		
			--½«µ±Ç°¸±±¾³¡¾°ÀïtoÕ ðµ ËùÓÐÈË´«ËÍ»ØÔ­À´½øÈëÊ±ºòtoÕ ðµ ³¡¾°
			local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
			
			local memId;
			for	i = 0, membercount - 1 do
				memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
				if LuaFnIsObjValid(sceneId, memId) == 1 and LuaFnIsCanDoScriptLogic(sceneId, memId) == 1 then
					NewWorld(sceneId, memId, oldsceneId, x, z);
				end
			end
			return
		end
		
		for	i = 0, membercount - 1 do
			memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
			if LuaFnIsObjValid(sceneId, memId) == 1 then
 				x808121_NotifyFailTips(sceneId, memId, strOutMsg);
 			end
		end		
	end
	
	curTickCount = curTickCount + 1;
	LuaFnSetCopySceneData_Param(sceneId, 2, curTickCount);--ÉèÖÃÐÂtoÕ ðµ ¶¨Ê±Æ÷µ÷ÓÃ´ÎÊý
	
end

--**********************************
--¸±±¾³¡¾°ÖÐÉ±ÁË¹Ö
--**********************************
function x808121_OnDie(sceneId, selfId, killerId)						-- ³¡¾°ID, ±»É±toÕ ðµ ObjId, É±ÊÖObjId

	CallScriptFunction(501000, "OnDie", sceneId, selfId, killerId) 
	
	--ÏÂÃæÐúngÍ³¼Æ¹¦ÄÜ
	local szName = GetName(sceneId, selfId)

	local AllMonsterNum = 0;
	--ÏÂÃæÐúngµÚmµt Åú,µÚ¶þÅú,µÚÈýÅú,µÚËÄÅú¹Ö,ºÍ6cáiboss(Á½cái´óboss,ËÄcáiÐ¡..)
--	AllMonsterNum = x808121_gFirst_MonstersTbl.size + x808121_gSecond_MonstersTbl.size + x808121_gThird_MonstersTbl.size + x808121_gFourth_MonstersTbl.size  
	AllMonsterNum = x808121_monster_First_num + x808121_monster_Second_num + x808121_monster_Third_num + x808121_monster_Fourth_num + x808121_monster_boss_num
	
	local nKilledMonsterNum_feng = LuaFnGetCopySceneData_Param(sceneId, 7);											--É±ËÀ·ïtoÕ ðµ ÊýÁ¿
	local nKilledMonsterNum_long = LuaFnGetCopySceneData_Param(sceneId, 11);											--É±ËÀÁútoÕ ðµ ÊýÁ¿
	local nKilledMonsterNum_boss = LuaFnGetCopySceneData_Param(sceneId, 13);											--É±ËÀbosstoÕ ðµ ÊýÁ¿
	
	local strOutMsg = ""
	local AuditType = 0
	if (szName == x808121_monster_chufeng.name) then
		nKilledMonsterNum_feng = nKilledMonsterNum_feng + 1
		LuaFnSetCopySceneData_Param(sceneId, 7, nKilledMonsterNum_feng);
		strOutMsg = strOutMsg.."ÒÑKhiêu chiªnThiên niên kì thú³û·ï: "..tostring(nKilledMonsterNum_feng).."/"..tostring(x808121_monster_Second_num + x808121_monster_Fourth_num)
		AuditType = 1
	elseif (szName == x808121_monster_leilin.name) then
		nKilledMonsterNum_long = nKilledMonsterNum_long + 1
		LuaFnSetCopySceneData_Param(sceneId, 11, nKilledMonsterNum_long);
		strOutMsg = strOutMsg.."ÒÑKhiêu chiªnThiên niên kì thúÀ×÷ë: "..tostring(nKilledMonsterNum_long).."/"..tostring(x808121_monster_Second_num + x808121_monster_Fourth_num)
		AuditType = 2
	elseif (szName == x808121_monster_xudaoshenshou.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."ÒÑÉ±ËÀ»¤µºÉñÊÞ: 1/1."
		AuditType = 3
	elseif (szName == x808121_monster_feitianmao.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."ÒÑÉ±ËÀVô Ð¸ch Phi Thiên Miêu: 1/1."
		AuditType = 4
	elseif (szName == x808121_monster_xiaozhuzhu.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."ÒÑÉ±ËÀÐ¡ÖíÖí: 1/1."
		AuditType = 5
	elseif (szName == x808121_monster_xiaohuhu.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."ÒÑÉ±ËÀÐ¡»¢»¢: 1/1."
		AuditType = 5
	elseif (szName == x808121_monster_xiaoyingying.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."ÒÑÉ±ËÀÐ¡Ó¥Ó¥: 1/1."
		AuditType = 5
	elseif (szName == x808121_monster_xiaogougou.name) then
		nKilledMonsterNum_boss = nKilledMonsterNum_boss + 1
		LuaFnSetCopySceneData_Param(sceneId, 13, nKilledMonsterNum_boss);
		strOutMsg = strOutMsg.."ÒÑÉ±ËÀÐ¡¹·¹·: 1/1."
		AuditType = 5
	end
	
	local nAllKilled = nKilledMonsterNum_feng + nKilledMonsterNum_long + nKilledMonsterNum_boss
	local membercount = LuaFnGetCopyScene_HumanCount(sceneId);
	for	i = 0, membercount - 1 do
		memId = LuaFnGetCopyScene_HumanObjId(sceneId, i);
		if LuaFnIsObjValid(sceneId, memId) == 1 then
 			x808121_NotifyFailTips(sceneId, memId, strOutMsg);
 		end
	end		

	if (nAllKilled >= AllMonsterNum) then
		LuaFnSetCopySceneData_Param(sceneId, 12, 4 )        --¸Ã×ßÁË
	end
end

--Õ¾TÕi Àë¿ª³¡¾°toÕ ðµ ¹âÓ°ÀïÃæ,×¼±¸È¥ÍùLâu Lan
function x808121_OnEnterArea( sceneId, selfId )
		local oldsceneId = LuaFnGetCopySceneData_Param(sceneId, 3);		--È¡ ði¬m¸±±¾Èë¿Ú³¡¾°ºÅ
		local x = LuaFnGetCopySceneData_Param(sceneId, 4);
		local z = LuaFnGetCopySceneData_Param(sceneId, 5);
		NewWorld(sceneId, selfId, oldsceneId, x, z);
end

function x808121_OnLeaveArea( sceneId, selfId )
end

function x808121_NotifyFailTips(sceneId, selfId, Tip)
	BeginEvent(sceneId);
		AddText(sceneId, Tip);
	EndEvent(sceneId);
	DispatchMissionTips(sceneId, selfId);
end


function x808121_CheckAllXinfaLevel(sceneId, memId)
	local nMenpai = GetMenPai(sceneId, memId)
	if nMenpai<0 or nMenpai>8   then
		return 0
	end
	
	for i=1, 6 do
		local nXinfaLevel = LuaFnGetXinFaLevel(sceneId, memId, nMenpai*6 + i)
		if nXinfaLevel < x808121_g_Low_Level_xinfa    then
			return 0
		end
	end
	return 1
end
